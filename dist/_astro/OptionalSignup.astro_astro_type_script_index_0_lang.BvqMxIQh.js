import{c as I}from"./wrapper.LS5g8wYr.js";const v="https://jdjqrlkynwfhbtyuddjk.supabase.co",k="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkanFybGt5bndmaGJ0eXVkZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NzUwMTEsImV4cCI6MjA4MDA1MTAxMX0.KDRMLCewVMp3lwphkUvtoWOkg6kyAk8iSbVkRKiHYSk",n=I(v,k);function _(){let e=localStorage.getItem("goodwatch_anon_id");return e||(e="anon_"+Math.random().toString(36).substring(2,15),localStorage.setItem("goodwatch_anon_id",e)),e}async function o(e,t,a){try{await n.from("auth_analytics").insert({event_type:e,auth_provider:t||null,trigger_reason:a||null,page_url:window.location.pathname,anonymous_id:_(),user_agent:navigator.userAgent})}catch(r){console.error("Failed to track auth event:",r)}}const S=1440*60*1e3;let w=!1,s="";const y=document.getElementById("signup-modal"),E=document.getElementById("signup-backdrop"),L=document.getElementById("signup-skip"),b=document.getElementById("signup-google"),B=document.getElementById("signup-apple"),p=document.getElementById("show-email-input"),M=document.getElementById("email-input-form"),g=document.getElementById("signup-email"),f=document.getElementById("send-magic-link"),O=document.getElementById("email-sent-toast"),c=document.getElementById("auth-error-toast"),m=document.getElementById("auth-error-message");async function T(){const{data:{user:e}}=await n.auth.getUser();return!!e}async function D(){if(w||await T())return!1;const e=localStorage.getItem("goodwatch_signup_skipped");if(e){const t=new Date(e).getTime();if(Date.now()-t<S)return!1}return!0}async function d(e="unknown"){await D()&&(w=!0,s=e,y?.classList.remove("hidden"),document.body.style.overflow="hidden",await o("signup_modal_shown",void 0,e))}function l(){y?.classList.add("hidden"),document.body.style.overflow=""}function i(e,t){e&&(t&&e.id==="auth-error-toast"&&m&&(m.textContent=t),e.classList.remove("translate-y-20","opacity-0"),setTimeout(()=>{e.classList.add("translate-y-20","opacity-0")},4e3))}async function A(){const{data:{user:e}}=await n.auth.getUser();if(!e)return;const t=localStorage.getItem("goodwatch_taste");if(!t)return;const a=JSON.parse(t);try{await n.from("users").upsert({id:e.id,email:e.email,taste_profile:a.tasteProfile||{},saved_movies:a.savedMovies||[],skipped_movies:a.skippedMovies||[],updated_at:new Date().toISOString()}),await o("signup_completed",void 0,s)}catch(r){console.error("Failed to sync data:",r)}}L?.addEventListener("click",async()=>{localStorage.setItem("goodwatch_signup_skipped",new Date().toISOString()),await o("signup_skipped",void 0,s),l()});E?.addEventListener("click",async()=>{localStorage.setItem("goodwatch_signup_skipped",new Date().toISOString()),await o("signup_skipped",void 0,s),l()});b?.addEventListener("click",async()=>{await o("signup_started","google",s);const{error:e}=await n.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`}});e&&i(c,e.message)});B?.addEventListener("click",async()=>{await o("signup_started","apple",s);const{error:e}=await n.auth.signInWithOAuth({provider:"apple",options:{redirectTo:`${window.location.origin}/auth/callback`}});e&&i(c,e.message)});p?.addEventListener("click",()=>{p.classList.add("hidden"),M?.classList.remove("hidden"),g?.focus()});f?.addEventListener("click",async()=>{const e=g?.value?.trim();if(!e||!e.includes("@")){i(c,"Please enter a valid email");return}await o("signup_started","email",s);const{error:t}=await n.auth.signInWithOtp({email:e,options:{emailRedirectTo:`${window.location.origin}/auth/callback`}});t?i(c,t.message):(l(),i(O))});g?.addEventListener("keypress",e=>{e.key==="Enter"&&f?.click()});window.addEventListener("tasteProfileUpdated",()=>{setTimeout(()=>d("taste_modal_complete"),1e3)});let u=0;const h=localStorage.getItem("goodwatch_taste");h&&(u=JSON.parse(h).savedMovies?.length||0);document.addEventListener("click",async e=>{const t=e.target;(t.closest("[data-save-movie]")||t.closest(".save-movie-btn"))&&(u++,u>=2&&setTimeout(()=>d("saved_movies"),1e3))});document.addEventListener("click",async e=>{if(e.target.closest("#refine-taste-btn")){const a=localStorage.getItem("goodwatch_taste");a&&JSON.parse(a).tasteProfile?.likedMovies?.length>0&&setTimeout(()=>d("refine_taste"),500)}});document.querySelectorAll("[data-trigger-signup]").forEach(e=>{e.addEventListener("click",()=>{d("explicit_click")})});n.auth.onAuthStateChange(async(e,t)=>{e==="SIGNED_IN"&&t?.user&&(await A(),l())});
