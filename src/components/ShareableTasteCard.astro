---
// ShareableTasteCard.astro - Generates shareable identity cards

import { supabase } from '../lib/supabase';

interface Props {
  userId: string;
}

const { userId } = Astro.props;

// Get user's taste profile
const { data: profile } = await supabase
  .from('user_taste_profile')
  .select('*')
  .eq('user_id', userId)
  .single();

// Get recent watch stats
const { data: recentWatches } = await supabase
  .from('user_watch_history')
  .select('reaction, movies!inner(genres)')
  .eq('user_id', userId)
  .eq('status', 'finished')
  .gte('finished_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())
  .limit(20);

// Calculate mood this week
const lovedCount = recentWatches?.filter(w => w.reaction === 'loved').length || 0;
const totalWatches = recentWatches?.length || 0;

// Get top genres
const genreCounts: Record<string, number> = {};
recentWatches?.forEach(w => {
  const genres = (w as any).movies?.genres || [];
  genres.forEach((g: any) => {
    const name = typeof g === 'string' ? g : g.name;
    if (name) genreCounts[name] = (genreCounts[name] || 0) + 1;
  });
});

const topGenres = Object.entries(genreCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 3)
  .map(([name]) => name);

// Determine mood label
let moodLabel = 'Explorer';
if (profile?.axis_light_heavy && profile.axis_light_heavy > 0.3) moodLabel = 'Deep Thinker';
else if (profile?.axis_light_heavy && profile.axis_light_heavy < -0.3) moodLabel = 'Feel-Good Seeker';
if (profile?.recent_mood_trend) moodLabel = profile.recent_mood_trend;

const hasData = totalWatches > 0 || profile;
---

{hasData && (
  <div class="bg-gradient-to-br from-gw-card to-gw-bg border border-gw-border rounded-2xl p-6 max-w-sm mx-auto">
    <div class="text-center mb-4">
      <p class="text-xs text-gw-text-secondary uppercase tracking-wide mb-1">My Movie Mood</p>
      <h2 class="text-2xl font-bold text-gw-accent">{moodLabel}</h2>
    </div>
    
    <div class="space-y-4">
      {topGenres.length > 0 && (
        <div>
          <p class="text-xs text-gw-text-secondary mb-2">Top Genres This Month</p>
          <div class="flex flex-wrap gap-2">
            {topGenres.map((genre, i) => (
              <span class={`px-3 py-1 rounded-full text-sm ${i === 0 ? 'bg-gw-accent text-gw-bg' : 'bg-gw-border'}`}>
                {genre}
              </span>
            ))}
          </div>
        </div>
      )}
      
      {totalWatches > 0 && (
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-gw-bg/50 rounded-lg p-3">
            <p class="text-2xl font-bold">{totalWatches}</p>
            <p class="text-xs text-gw-text-secondary">Watched</p>
          </div>
          <div class="bg-gw-bg/50 rounded-lg p-3">
            <p class="text-2xl font-bold">{lovedCount}</p>
            <p class="text-xs text-gw-text-secondary">Loved ðŸ’š</p>
          </div>
        </div>
      )}
      
      {profile?.axis_light_heavy !== undefined && (
        <div>
          <p class="text-xs text-gw-text-secondary mb-2">Taste Spectrum</p>
          <div class="flex items-center gap-2 text-xs">
            <span>Light</span>
            <div class="flex-1 h-2 bg-gw-border rounded-full overflow-hidden">
              <div 
                class="h-full bg-gw-accent rounded-full transition-all"
                style={`width: ${((profile.axis_light_heavy + 1) / 2) * 100}%`}
              ></div>
            </div>
            <span>Heavy</span>
          </div>
        </div>
      )}
    </div>
    
    <div class="mt-6 pt-4 border-t border-gw-border flex items-center justify-between">
      <span class="text-xs text-gw-text-secondary">goodwatch.movie</span>
      <button id="share-taste-card" class="text-sm text-gw-accent hover:underline">Share â†’</button>
    </div>
  </div>
)}

<script>
  document.getElementById('share-taste-card')?.addEventListener('click', async () => {
    if (navigator.share) {
      await navigator.share({
        title: 'My Movie Mood - GoodWatch',
        text: 'Check out my movie taste profile!',
        url: window.location.href
      }).catch(() => {});
    } else {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied!');
    }
  });
</script>
