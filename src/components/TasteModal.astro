---
// TasteModal.astro - Taste Calibration Modal
// NOT skippable - required for better recommendations

// Sample movies for quick picks - diverse across languages, eras, tones
const sampleMovies = [
  { id: 27205, title: "Inception", poster: "/edv5CZvWj09upOsy2Y6IwDhK8bt.jpg" },
  { id: 155, title: "The Dark Knight", poster: "/qJ2tW6WMUDux911r6m7haRef0WH.jpg" },
  { id: 389, title: "3 Idiots", poster: "/66A9MqXOyVFCssoloscw79z8Tew.jpg" },
  { id: 19404, title: "Dilwale Dulhania Le Jayenge", poster: "/ktejodbcdCPXbMMdnpI9BUxW6O8.jpg" },
  { id: 680, title: "Pulp Fiction", poster: "/d5iIlFn5s0ImszYzBPb8JPIfbXD.jpg" },
  { id: 238, title: "The Godfather", poster: "/3bhkrj58Vtu7enYsRolD1fZdja1.jpg" },
  { id: 244786, title: "Whiplash", poster: "/oPxnRhyAIzJKGUEdSiwTJQBa3NM.jpg" },
  { id: 496243, title: "Parasite", poster: "/7IiTTgloJzvGI1TAYymCfbfl3vT.jpg" },
];
---

<!-- Taste Calibration Modal -->
<div id="taste-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop (no click to close) -->
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
  
  <!-- Modal Content -->
  <div class="relative flex items-center justify-center min-h-screen p-4">
    <div class="bg-gw-card border border-gw-border rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
      
      <!-- Header -->
      <div class="p-6 border-b border-gw-border">
        <h2 class="text-xl font-bold">Help us understand your taste</h2>
        <p class="text-sm text-gw-text-secondary mt-1">This takes 30 seconds and makes recommendations much better.</p>
      </div>
      
      <!-- Steps Container -->
      <div class="p-6">
        
        <!-- Step 1: Languages -->
        <div id="taste-step-1" class="taste-step">
          <h3 class="font-medium mb-4">Which languages do you usually watch?</h3>
          <div class="grid grid-cols-2 gap-3">
            {['English', 'Hindi', 'Tamil', 'Telugu', 'Malayalam', 'No preference'].map(lang => (
              <button 
                type="button"
                class="lang-option px-4 py-3 bg-gw-bg border-2 border-gw-border rounded-lg text-sm hover:border-gw-accent transition text-left"
                data-lang={lang}
              >
                {lang}
              </button>
            ))}
          </div>
          <p class="text-xs text-gw-text-secondary mt-3">Select up to 2</p>
        </div>
        
        <!-- Step 2: Era -->
        <div id="taste-step-2" class="taste-step hidden">
          <h3 class="font-medium mb-4">What era of movies do you usually enjoy?</h3>
          <div class="space-y-3">
            {[
              { value: 'recent', label: 'Recent (last 5-7 years)' },
              { value: '2000s', label: '2000s' },
              { value: 'classic', label: '90s & earlier' },
              { value: 'none', label: 'No preference' }
            ].map(era => (
              <button 
                type="button"
                class="era-option w-full px-4 py-3 bg-gw-bg border-2 border-gw-border rounded-lg text-sm text-left hover:border-gw-accent transition"
                data-era={era.value}
              >
                {era.label}
              </button>
            ))}
          </div>
        </div>
        
        <!-- Step 3: Movie Picks -->
        <div id="taste-step-3" class="taste-step hidden">
          <h3 class="font-medium mb-4">Pick a few movies you like</h3>
          <p class="text-xs text-gw-text-secondary mb-4">Select at least 2</p>
          <div class="grid grid-cols-4 gap-3">
            {sampleMovies.map(movie => (
              <button 
                type="button"
                class="movie-pick-option relative aspect-[2/3] rounded-lg overflow-hidden border-3 border-transparent hover:border-gw-accent transition"
                data-movie-id={movie.id}
                data-movie-title={movie.title}
              >
                <img 
                  src={`https://image.tmdb.org/t/p/w185${movie.poster}`}
                  alt={movie.title}
                  class="w-full h-full object-cover"
                  loading="lazy"
                />
                <div class="movie-pick-check absolute inset-0 bg-gw-accent/80 flex items-center justify-center opacity-0 transition">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
              </button>
            ))}
          </div>
        </div>
        
      </div>
      
      <!-- Footer (no skip button) -->
      <div class="p-6 border-t border-gw-border flex justify-end items-center">
        <div class="flex gap-3">
          <button id="taste-back" class="hidden px-4 py-2 text-sm border border-gw-border rounded-lg hover:bg-gw-border transition">
            Back
          </button>
          <button id="taste-next" class="px-6 py-2 bg-gw-accent hover:bg-gw-accent-hover text-gw-bg rounded-lg font-medium text-sm transition">
            Next
          </button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
  // Taste Modal Logic
  (function() {
    // State
    let currentStep = 1;
    let selectedLanguages: string[] = [];
    let selectedEra: string | null = null;
    let selectedMovies: number[] = [];
    let hasInteracted = false;
    let modalShownThisSession = false;
    
    // Elements
    const modal = document.getElementById('taste-modal');
    const backBtn = document.getElementById('taste-back');
    const nextBtn = document.getElementById('taste-next');
    
    // Check if should show modal
    function shouldShowModal(): boolean {
      if (modalShownThisSession) return false;
      
      const stored = localStorage.getItem('goodwatch_taste');
      if (stored) {
        const data = JSON.parse(stored);
        // Only skip if profile is complete (has liked movies)
        if (data.tasteProfile?.likedMovies?.length > 0) {
          return false;
        }
      }
      return true;
    }
    
    // Show modal
    function showModal() {
      if (!shouldShowModal()) return;
      modalShownThisSession = true;
      modal?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    // Hide modal
    function hideModal() {
      modal?.classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // Update step visibility
    function updateStep() {
      document.querySelectorAll('.taste-step').forEach((el, i) => {
        el.classList.toggle('hidden', i + 1 !== currentStep);
      });
      
      backBtn?.classList.toggle('hidden', currentStep === 1);
      
      if (nextBtn) {
        nextBtn.textContent = currentStep === 3 ? 'Done' : 'Next';
      }
    }
    
    // Save to localStorage
    function saveProfile() {
      const data = {
        tasteProfile: {
          languages: selectedLanguages,
          era: selectedEra,
          likedMovies: selectedMovies,
          createdAt: Date.now()
        },
        hasSeenTasteModal: true,
        savedMovies: [],
        skippedMovies: []
      };
      
      // Merge with existing data
      const existing = localStorage.getItem('goodwatch_taste');
      if (existing) {
        const parsed = JSON.parse(existing);
        data.savedMovies = parsed.savedMovies || [];
        data.skippedMovies = parsed.skippedMovies || [];
      }
      
      localStorage.setItem('goodwatch_taste', JSON.stringify(data));
    }
    
    // Language selection
    document.querySelectorAll('.lang-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang') || '';
        
        if (lang === 'No preference') {
          selectedLanguages = ['No preference'];
          document.querySelectorAll('.lang-option').forEach(b => {
            b.classList.remove('border-gw-accent', 'bg-gw-accent/20');
            b.classList.add('border-gw-border');
          });
          btn.classList.remove('border-gw-border');
          btn.classList.add('border-gw-accent', 'bg-gw-accent/20');
        } else {
          // Remove "No preference" if selected
          const noPreferenceBtn = document.querySelector('.lang-option[data-lang="No preference"]');
          noPreferenceBtn?.classList.remove('border-gw-accent', 'bg-gw-accent/20');
          noPreferenceBtn?.classList.add('border-gw-border');
          selectedLanguages = selectedLanguages.filter(l => l !== 'No preference');
          
          if (selectedLanguages.includes(lang)) {
            selectedLanguages = selectedLanguages.filter(l => l !== lang);
            btn.classList.remove('border-gw-accent', 'bg-gw-accent/20');
            btn.classList.add('border-gw-border');
          } else if (selectedLanguages.length < 2) {
            selectedLanguages.push(lang);
            btn.classList.remove('border-gw-border');
            btn.classList.add('border-gw-accent', 'bg-gw-accent/20');
          }
        }
      });
    });
    
    // Era selection
    document.querySelectorAll('.era-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.era-option').forEach(b => {
          b.classList.remove('border-gw-accent', 'bg-gw-accent/20');
          b.classList.add('border-gw-border');
        });
        btn.classList.remove('border-gw-border');
        btn.classList.add('border-gw-accent', 'bg-gw-accent/20');
        selectedEra = btn.getAttribute('data-era');
      });
    });
    
    // Movie selection
    document.querySelectorAll('.movie-pick-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const movieId = parseInt(btn.getAttribute('data-movie-id') || '0');
        const checkEl = btn.querySelector('.movie-pick-check');
        
        if (selectedMovies.includes(movieId)) {
          selectedMovies = selectedMovies.filter(id => id !== movieId);
          btn.classList.remove('border-gw-accent');
          btn.classList.add('border-transparent');
          checkEl?.classList.add('opacity-0');
        } else {
          selectedMovies.push(movieId);
          btn.classList.remove('border-transparent');
          btn.classList.add('border-gw-accent');
          checkEl?.classList.remove('opacity-0');
        }
      });
    });
    
    // Navigation
    nextBtn?.addEventListener('click', () => {
      if (currentStep === 1 && selectedLanguages.length === 0) {
        alert('Please select at least one language preference');
        return;
      }
      if (currentStep === 2 && !selectedEra) {
        alert('Please select an era preference');
        return;
      }
      if (currentStep === 3) {
        if (selectedMovies.length < 2) {
          alert('Please pick at least 2 movies');
          return;
        }
        saveProfile();
        hideModal();
        // Trigger recommendation refresh
        window.dispatchEvent(new CustomEvent('tasteProfileUpdated'));
      } else {
        currentStep++;
        updateStep();
      }
    });
    
    backBtn?.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        updateStep();
      }
    });
    
    // Trigger conditions
    // 1. User clicks a mood
    document.querySelectorAll('[data-mood]').forEach(el => {
      el.addEventListener('click', () => {
        if (!hasInteracted) {
          hasInteracted = true;
          setTimeout(() => showModal(), 500);
        }
      });
    });
    
    // 2. User scrolls past hero
    let scrollTriggered = false;
    window.addEventListener('scroll', () => {
      if (scrollTriggered || hasInteracted) return;
      if (window.scrollY > window.innerHeight * 0.5) {
        scrollTriggered = true;
        hasInteracted = true;
        setTimeout(() => showModal(), 1000);
      }
    });
    
    // 3. User tries to save a movie
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('[data-save-movie]') && !hasInteracted) {
        hasInteracted = true;
        setTimeout(() => showModal(), 500);
      }
    });
    
    // 4. User stays > 15 seconds
    setTimeout(() => {
      if (!hasInteracted) {
        hasInteracted = true;
        showModal();
      }
    }, 15000);
    
  })();
</script>

<style>
  .taste-step {
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .border-3 {
    border-width: 3px;
  }
</style>
