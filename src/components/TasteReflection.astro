---
// TasteReflection.astro - Shows taste insights

import { supabase } from '../lib/supabase';

interface Props {
  userId: string;
}

const { userId } = Astro.props;

// Get active reflections
const { data: reflections } = await supabase
  .from('taste_reflections')
  .select('*')
  .eq('user_id', userId)
  .eq('is_dismissed', false)
  .gte('valid_until', new Date().toISOString())
  .order('created_at', { ascending: false })
  .limit(3);

const reflectionConfig: Record<string, { icon: string; color: string }> = {
  mood_shift: { icon: 'ðŸŒ™', color: 'from-purple-500/20 to-blue-500/20' },
  genre_discovery: { icon: '', color: 'from-green-500/20 to-teal-500/20' },
  runtime_change: { icon: 'â±ï¸', color: 'from-orange-500/20 to-yellow-500/20' },
  streak: { icon: 'ðŸ”¥', color: 'from-red-500/20 to-orange-500/20' },
  milestone: { icon: 'ðŸ†', color: 'from-yellow-500/20 to-amber-500/20' },
  genre_avoidance: { icon: '', color: 'from-gray-500/20 to-slate-500/20' }
};
---

{reflections && reflections.length > 0 && (
  <div class="space-y-3">
    {reflections.map(r => {
      const config = reflectionConfig[r.reflection_type] || { icon: 'ðŸ’¡', color: 'from-gw-accent/20 to-gw-accent/10' };
      return (
        <div 
          class={`bg-gradient-to-r ${config.color} border border-gw-border rounded-xl p-4 flex items-start gap-3`}
          data-reflection-id={r.id}
        >
          <span class="text-2xl flex-shrink-0">{config.icon}</span>
          <div class="flex-1 min-w-0">
            <h3 class="font-medium">{r.title}</h3>
            {r.body && <p class="text-sm text-gw-text-secondary mt-1">{r.body}</p>}
          </div>
          <button 
            class="text-gw-text-secondary hover:text-white transition flex-shrink-0 p-1"
            data-dismiss={r.id}
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      );
    })}
  </div>
)}

<script define:vars={{ visitorId: userId }}>
  document.querySelectorAll('[data-dismiss]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const reflectionId = btn.dataset.dismiss;
      const card = document.querySelector(`[data-reflection-id="${reflectionId}"]`);
      card?.remove();
      
      await fetch('/api/dismiss-reflection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reflectionId, userId: visitorId })
      }).catch(() => {});
    });
  });
</script>
