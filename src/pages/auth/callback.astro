---
/**
 * Auth Callback Page
 * Handles OAuth redirects and magic link clicks
 */
import Layout from '../../layouts/Layout.astro';
---

<Layout 
  title="Signing in... | GoodWatch"
  description="Completing your sign in to GoodWatch"
  noindex={true}
>
  <div class="min-h-[60vh] flex items-center justify-center">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-gw-accent border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
      <h1 class="text-2xl font-bold mb-2">Signing you in...</h1>
      <p class="text-gw-text-secondary">Just a moment while we set things up.</p>
    </div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabaseUrl = 'https://jdjqrlkynwfhbtyuddjk.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkanFybGt5bndmaGJ0eXVkZGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NzUwMTEsImV4cCI6MjA4MDA1MTAxMX0.KDRMLCewVMp3lwphkUvtoWOkg6kyAk8iSbVkRKiHYSk';
  const supabase = createClient(supabaseUrl, supabaseKey);
  
  async function handleAuthCallback() {
    try {
      // Get the auth code from URL
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const queryParams = new URLSearchParams(window.location.search);
      
      // Check for error
      const error = hashParams.get('error') || queryParams.get('error');
      if (error) {
        console.error('Auth error:', error);
        window.location.href = '/?auth_error=' + encodeURIComponent(error);
        return;
      }
      
      // Exchange code for session if present
      const code = queryParams.get('code');
      if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
          console.error('Code exchange error:', error);
          window.location.href = '/?auth_error=' + encodeURIComponent(error.message);
          return;
        }
      }
      
      // Get current session
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session?.user) {
        // Sync local data to profile
        const localData = localStorage.getItem('goodwatch_taste');
        if (localData) {
          const parsed = JSON.parse(localData);
          
          await supabase.from('users').upsert({
            id: session.user.id,
            email: session.user.email,
            display_name: session.user.user_metadata?.full_name || session.user.user_metadata?.name,
            avatar_url: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
            auth_provider: session.user.app_metadata?.provider || 'email',
            taste_profile: parsed.tasteProfile || {},
            saved_movies: parsed.savedMovies || [],
            skipped_movies: parsed.skippedMovies || [],
            updated_at: new Date().toISOString(),
          });
          
          // Track signup completion
          const anonId = localStorage.getItem('goodwatch_anon_id');
          await supabase.from('auth_analytics').insert({
            event_type: 'signup_completed',
            auth_provider: session.user.app_metadata?.provider || 'email',
            anonymous_id: anonId,
            user_id: session.user.id,
            page_url: '/auth/callback',
          });
        }
        
        // Redirect to home
        window.location.href = '/?signed_in=true';
      } else {
        // No session, redirect to home
        window.location.href = '/';
      }
    } catch (err) {
      console.error('Auth callback error:', err);
      window.location.href = '/?auth_error=unexpected';
    }
  }
  
  handleAuthCallback();
</script>
