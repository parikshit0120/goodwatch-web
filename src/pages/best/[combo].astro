---
import Layout from '../../layouts/Layout.astro';
import { getMoviesByMoodAndGenre, getMoviesByGenre, getPosterUrl, slugify, generateItemListSchema, generateBreadcrumbSchema, MOODS, GENRES, getRelatedMoods, getRelatedGenres } from '../../lib/supabase';

export const prerender = false;

// Define long-tail keyword combinations
const BEST_COMBINATIONS = [
  // Mood + Genre combinations
  { slug: 'feel-good-comedies', title: 'Feel-Good Comedies', mood: 'Feel-Good', genre: 'Comedy', description: 'Heartwarming comedies that will lift your spirits' },
  { slug: 'romantic-dramas', title: 'Romantic Dramas', mood: 'Romantic', genre: 'Drama', description: 'Emotional love stories that tug at your heartstrings' },
  { slug: 'thrilling-action', title: 'Thrilling Action Movies', mood: 'Thrilling', genre: 'Action', description: 'Heart-pounding action films that keep you on the edge' },
  { slug: 'mind-bending-sci-fi', title: 'Mind-Bending Sci-Fi', mood: 'Mind-Bending', genre: 'Science Fiction', description: 'Sci-fi films that will make you question reality' },
  { slug: 'dark-thrillers', title: 'Dark Thrillers', mood: 'Dark', genre: 'Thriller', description: 'Intense psychological thrillers with dark themes' },
  { slug: 'inspirational-dramas', title: 'Inspirational Dramas', mood: 'Inspirational', genre: 'Drama', description: 'True stories and fictional tales that inspire' },
  { slug: 'funny-animations', title: 'Funny Animated Movies', mood: 'Funny', genre: 'Animation', description: 'Hilarious animated films for all ages' },
  { slug: 'adventurous-fantasy', title: 'Adventurous Fantasy Films', mood: 'Adventurous', genre: 'Fantasy', description: 'Epic fantasy adventures in magical worlds' },
  { slug: 'emotional-romance', title: 'Emotional Romance Movies', mood: 'Emotional', genre: 'Romance', description: 'Romance films that will make you feel deeply' },
  { slug: 'mysterious-crime', title: 'Mysterious Crime Films', mood: 'Mysterious', genre: 'Crime', description: 'Crime movies with twists you won\'t see coming' },
  { slug: 'nostalgic-family', title: 'Nostalgic Family Movies', mood: 'Nostalgic', genre: 'Family', description: 'Classic family films that bring back memories' },
  { slug: 'intense-horror', title: 'Intense Horror Movies', mood: 'Intense', genre: 'Horror', description: 'Horror films that will truly terrify you' },
  { slug: 'uplifting-musicals', title: 'Uplifting Musicals', mood: 'Uplifting', genre: 'Music', description: 'Musical films that will have you singing along' },
  { slug: 'thought-provoking-documentaries', title: 'Thought-Provoking Documentaries', mood: 'Thought-Provoking', genre: 'Documentary', description: 'Documentaries that change how you see the world' },
  { slug: 'relaxing-comedies', title: 'Relaxing Comedies', mood: 'Relaxing', genre: 'Comedy', description: 'Light-hearted comedies perfect for unwinding' },
];

const { combo: comboSlug } = Astro.params;

// Find the combo by slug
const combo = BEST_COMBINATIONS.find(c => c.slug === comboSlug);

if (!combo) {
  return Astro.redirect('/best');
}

const movies = await getMoviesByMoodAndGenre(combo.mood, combo.genre, 30);
const siteUrl = 'https://goodwatch.movie';

const itemListSchema = generateItemListSchema(`Best ${combo.title}`, movies, siteUrl);
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: '/' },
  { name: 'Best Movies', url: '/best' },
  { name: combo.title, url: `/best/${combo.slug}` }
], siteUrl);

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": `What are the best ${combo.title.toLowerCase()} to watch?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Top ${combo.title.toLowerCase()} include ${movies.slice(0,5).map(m => m.title).join(', ')}. We've curated ${movies.length}+ films that combine ${combo.mood.toLowerCase()} vibes with ${combo.genre.toLowerCase()} elements.`
      }
    },
    {
      "@type": "Question",
      "name": `Where can I stream ${combo.title.toLowerCase()}?`,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Many ${combo.title.toLowerCase()} are available on popular streaming services like Netflix, Prime Video, and Disney+. Click on any movie to see its current streaming availability.`
      }
    }
  ]
};

const combinedSchema = [itemListSchema, breadcrumbSchema, faqSchema];
const relatedMoods = getRelatedMoods(combo.mood);
const relatedGenres = getRelatedGenres(combo.genre);
---

<Layout 
  title={`Best ${combo.title} | ${movies.length}+ Must-Watch Movies`}
  description={`${combo.description}. Discover ${movies.length}+ of the best ${combo.title.toLowerCase()} to watch in 2025. Curated recommendations with streaming info.`}
  schema={combinedSchema}
>
  <div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gw-text-secondary mb-6">
      <a href="/" class="hover:text-white">Home</a>
      <span class="mx-2">›</span>
      <a href="/best" class="hover:text-white">Best Movies</a>
      <span class="mx-2">›</span>
      <span class="text-white">{combo.title}</span>
    </nav>

    <h1 class="text-4xl md:text-5xl font-bold mb-4">Best {combo.title}</h1>
    <p class="text-xl text-gw-text-secondary mb-8 max-w-3xl">
      {combo.description}. Browse {movies.length}+ hand-picked films that perfectly blend 
      {combo.mood.toLowerCase()} vibes with {combo.genre.toLowerCase()} storytelling.
    </p>

    <!-- Quick filters -->
    <div class="flex flex-wrap gap-2 mb-8">
      <a href={`/mood/${slugify(combo.mood)}`} class="px-3 py-1 bg-gw-accent/20 text-gw-accent rounded-full text-sm">
        {combo.mood}
      </a>
      <a href={`/genre/${slugify(combo.genre)}`} class="px-3 py-1 bg-gw-accent/20 text-gw-accent rounded-full text-sm">
        {combo.genre}
      </a>
    </div>

    <!-- Movies Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-16">
      {movies.map((movie) => (
        <a href={`/movie/${movie.tmdb_id}`} class="group">
          <div class="aspect-[2/3] rounded-lg overflow-hidden bg-gw-card mb-2">
            <img 
              src={getPosterUrl(movie.poster_path, 'w300')} 
              alt={`${movie.title} poster`}
              class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
              loading="lazy"
            />
          </div>
          <h3 class="font-medium text-sm line-clamp-1 group-hover:text-gw-accent transition">
            {movie.title}
          </h3>
          <div class="flex items-center gap-2 text-xs text-gw-text-secondary">
            <span>{movie.year}</span>
            {movie.vote_average && (
              <>
                <span>•</span>
                <span class="flex items-center gap-1">
                  <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  {movie.vote_average.toFixed(1)}
                </span>
              </>
            )}
          </div>
        </a>
      ))}
    </div>

    <!-- SEO Content -->
    <section class="border-t border-gw-border pt-12">
      <h2 class="text-2xl font-bold mb-6">What Makes Great {combo.title}?</h2>
      <div class="prose prose-invert max-w-none">
        <p class="text-gw-text-secondary mb-4">
          The best {combo.title.toLowerCase()} combine the emotional impact of {combo.mood.toLowerCase()} storytelling 
          with the conventions of the {combo.genre.toLowerCase()} genre. This unique blend creates films that 
          entertain while resonating on a deeper level.
        </p>
        <p class="text-gw-text-secondary mb-4">
          Our curation considers critical acclaim, audience ratings, and that special quality that makes 
          certain films stand out. Whether you're a longtime fan or new to {combo.title.toLowerCase()}, 
          you'll find something to love in this collection.
        </p>
      </div>

      <!-- Related Categories -->
      <div class="mt-12">
        <h3 class="text-xl font-bold mb-4">Similar Moods</h3>
        <div class="flex flex-wrap gap-3">
          {relatedMoods.map(mood => (
            <a 
              href={`/mood/${slugify(mood)}`}
              class="px-4 py-2 bg-gw-card hover:bg-gw-accent hover:text-gw-bg border border-gw-border rounded-full transition text-sm"
            >
              {mood}
            </a>
          ))}
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-xl font-bold mb-4">Related Genres</h3>
        <div class="flex flex-wrap gap-3">
          {relatedGenres.map(genre => (
            <a 
              href={`/genre/${slugify(genre)}`}
              class="px-4 py-2 bg-gw-card hover:bg-gw-border border border-gw-border rounded-full transition text-sm"
            >
              {genre}
            </a>
          ))}
        </div>
      </div>
    </section>
  </div>
</Layout>
