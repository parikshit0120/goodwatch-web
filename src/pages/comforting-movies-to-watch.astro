---
import Layout from '../layouts/Layout.astro';
import { supabase, getPosterUrl } from '../lib/supabase';

export const prerender = false;

// Get comforting movies (Comedy, Romance, Family, feel-good genres)
const { data: snapshots } = await supabase
  .from('decision_snapshots')
  .select('tmdb_id, confidence_score, providers, movie_id')
  .eq('region', 'IN')
  .eq('is_valid', true)
  .gte('confidence_score', 0.4)
  .limit(200);

// Get movie details
let allMovies: any[] = [];
if (snapshots && snapshots.length > 0) {
  const movieIds = snapshots.map(s => s.movie_id).filter(Boolean);
  const { data: movieData } = await supabase
    .from('movies')
    .select('id, tmdb_id, title, year, poster_path, overview, runtime, genres, imdb_rating, imdb_votes, original_language')
    .in('id', movieIds)
    .not('imdb_rating', 'is', null)
    .gte('imdb_rating', 6.5);
  
  if (movieData) {
    // Filter for feel-good genres
    allMovies = movieData.filter(m => 
      m.genres?.some((g: any) => {
        const name = typeof g === 'string' ? g : g?.name;
        return ['Comedy', 'Romance', 'Family', 'Animation', 'Music'].includes(name);
      })
    );
    
    // Add provider info
    allMovies = allMovies.map(movie => {
      const snap = snapshots.find(s => s.movie_id === movie.id);
      const provider = snap?.providers?.find((p: any) => p.type === 'flatrate');
      return { ...movie, provider: provider?.name || null };
    });
    
    // Sort by votes (popularity proxy)
    allMovies.sort((a, b) => (b.imdb_votes || 0) - (a.imdb_votes || 0));
  }
}

const movies = allMovies.slice(0, 20);
const quickComfort = allMovies.filter(m => m.runtime && m.runtime <= 100).slice(0, 6);
const familyMovies = allMovies.filter(m => 
  m.genres?.some((g: any) => ['Family', 'Animation'].includes(g.name || g))
).slice(0, 6);
const romanticComedy = allMovies.filter(m => 
  m.genres?.some((g: any) => g.name === 'Romance' || g === 'Romance') &&
  m.genres?.some((g: any) => g.name === 'Comedy' || g === 'Comedy')
).slice(0, 6);

function getGenreName(g: any): string {
  return typeof g === 'string' ? g : g?.name || '';
}

const today = new Date().toLocaleDateString('en-IN', { 
  weekday: 'long', 
  day: 'numeric', 
  month: 'long', 
  year: 'numeric' 
});
---

<Layout 
  title="Comforting Movies to Watch Tonight - Feel Good Films Streaming Now | GoodWatch"
  description="Need a comforting movie after a long day? Here are the best feel-good films streaming in India - warm, uplifting, and easy to watch. Perfect for unwinding tonight."
>
  <main class="min-h-screen bg-gw-bg">
    <article class="max-w-4xl mx-auto px-4 py-12">
      
      <!-- Header -->
      <header class="mb-12">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">
          Comforting Movies to Watch Tonight
        </h1>
        <p class="text-gw-text-secondary text-lg leading-relaxed mb-4">
          Had a long day? These feel-good movies are warm, familiar, and require zero effort. 
          No heavy themes, no stress — just comforting stories to help you unwind. 
          All available to stream in India right now.
        </p>
        <p class="text-sm text-gw-text-secondary">
          <span class="text-gw-accent">●</span> Updated: {today} · {movies.length} comforting picks verified
        </p>
      </header>
      
      <!-- Best Comforting Movies -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6">Best Feel-Good Movies Streaming Now</h2>
        <div class="grid gap-6">
          {movies.slice(0, 10).map((movie, i) => (
            <a href={`/movie/${movie.tmdb_id}`} class="flex gap-4 bg-gw-card border border-gw-border rounded-xl p-4 hover:border-gw-accent/50 transition group">
              <img 
                src={getPosterUrl(movie.poster_path, 'w185')} 
                alt={movie.title}
                class="w-20 h-28 object-cover rounded-lg flex-shrink-0"
                loading={i < 3 ? 'eager' : 'lazy'}
              />
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-lg group-hover:text-gw-accent transition">{movie.title}</h3>
                <div class="flex flex-wrap items-center gap-2 text-sm text-gw-text-secondary mt-1">
                  <span>{movie.year}</span>
                  {movie.runtime && <span>· {movie.runtime} min</span>}
                  {movie.imdb_rating && (
                    <span class="flex items-center gap-1">
                      · <span class="bg-[#F5C518] text-black text-xs font-bold px-1 rounded">IMDb</span>
                      {Number(movie.imdb_rating).toFixed(1)}
                    </span>
                  )}
                </div>
                {movie.genres && (
                  <p class="text-xs text-gw-text-secondary mt-1">
                    {movie.genres.slice(0, 3).map((g: any) => getGenreName(g)).join(' · ')}
                  </p>
                )}
                {movie.provider && (
                  <p class="text-sm text-gw-accent mt-2">Streaming on {movie.provider}</p>
                )}
                {movie.overview && (
                  <p class="text-sm text-gw-text-secondary mt-2 line-clamp-2">{movie.overview}</p>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
      
      <!-- Quick Comfort -->
      {quickComfort.length > 0 && (
        <section class="mb-16">
          <h2 class="text-2xl font-semibold mb-2">Quick Comfort (Under 100 min)</h2>
          <p class="text-gw-text-secondary mb-6">Short, sweet, and easy to finish before bed.</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {quickComfort.map(movie => (
              <a href={`/movie/${movie.tmdb_id}`} class="group">
                <div class="aspect-[2/3] rounded-lg overflow-hidden mb-2">
                  <img 
                    src={getPosterUrl(movie.poster_path, 'w342')} 
                    alt={movie.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition"
                    loading="lazy"
                  />
                </div>
                <h3 class="font-medium text-sm truncate group-hover:text-gw-accent">{movie.title}</h3>
                <p class="text-xs text-gw-text-secondary">{movie.runtime} min · {movie.provider || 'Streaming'}</p>
              </a>
            ))}
          </div>
        </section>
      )}
      
      <!-- Romantic Comedies -->
      {romanticComedy.length > 0 && (
        <section class="mb-16">
          <h2 class="text-2xl font-semibold mb-2">Romantic Comedies</h2>
          <p class="text-gw-text-secondary mb-6">Light-hearted love stories with happy endings.</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {romanticComedy.map(movie => (
              <a href={`/movie/${movie.tmdb_id}`} class="group">
                <div class="aspect-[2/3] rounded-lg overflow-hidden mb-2">
                  <img 
                    src={getPosterUrl(movie.poster_path, 'w342')} 
                    alt={movie.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition"
                    loading="lazy"
                  />
                </div>
                <h3 class="font-medium text-sm truncate group-hover:text-gw-accent">{movie.title}</h3>
                <p class="text-xs text-gw-text-secondary">IMDb {Number(movie.imdb_rating).toFixed(1)}</p>
              </a>
            ))}
          </div>
        </section>
      )}
      
      <!-- Family Movies -->
      {familyMovies.length > 0 && (
        <section class="mb-16">
          <h2 class="text-2xl font-semibold mb-2">Family-Friendly Comfort</h2>
          <p class="text-gw-text-secondary mb-6">Watch with the whole family or enjoy the nostalgia solo.</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {familyMovies.map(movie => (
              <a href={`/movie/${movie.tmdb_id}`} class="group">
                <div class="aspect-[2/3] rounded-lg overflow-hidden mb-2">
                  <img 
                    src={getPosterUrl(movie.poster_path, 'w342')} 
                    alt={movie.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition"
                    loading="lazy"
                  />
                </div>
                <h3 class="font-medium text-sm truncate group-hover:text-gw-accent">{movie.title}</h3>
                <p class="text-xs text-gw-text-secondary">{movie.year} · {movie.provider || 'Streaming'}</p>
              </a>
            ))}
          </div>
        </section>
      )}
      
      <!-- Other Moods -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6">Not in the mood for comfort?</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <a href="/mood/thrilling" class="bg-gw-card border border-gw-border rounded-xl p-4 hover:border-gw-accent/50 transition">
            <h3 class="font-medium mb-1">Thrilling</h3>
            <p class="text-sm text-gw-text-secondary">Edge-of-seat excitement</p>
          </a>
          <a href="/mood/emotional" class="bg-gw-card border border-gw-border rounded-xl p-4 hover:border-gw-accent/50 transition">
            <h3 class="font-medium mb-1">Emotional</h3>
            <p class="text-sm text-gw-text-secondary">Deep, moving stories</p>
          </a>
          <a href="/mood/relaxing" class="bg-gw-card border border-gw-border rounded-xl p-4 hover:border-gw-accent/50 transition">
            <h3 class="font-medium mb-1">Relaxing</h3>
            <p class="text-sm text-gw-text-secondary">Slow, atmospheric films</p>
          </a>
        </div>
      </section>
      
      <!-- FAQs -->
      <section class="mb-16">
        <h2 class="text-2xl font-semibold mb-6">FAQs</h2>
        <div class="space-y-4" itemscope itemtype="https://schema.org/FAQPage">
          
          <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" class="bg-gw-card border border-gw-border rounded-xl p-5">
            <h3 itemprop="name" class="font-medium mb-2">What is a good comforting movie to watch?</h3>
            <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
              <p itemprop="text" class="text-sm text-gw-text-secondary">
                Good comforting movies are feel-good stories with warm characters, light humor, and happy or hopeful endings. 
                Popular choices include comedies, romantic films, and family-friendly adventures. 
                Currently streaming: {movies.slice(0, 3).map(m => m.title).join(', ')}.
              </p>
            </div>
          </div>
          
          <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" class="bg-gw-card border border-gw-border rounded-xl p-5">
            <h3 itemprop="name" class="font-medium mb-2">What movie should I watch after a bad day?</h3>
            <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
              <p itemprop="text" class="text-sm text-gw-text-secondary">
                After a rough day, pick something light and familiar. Romantic comedies, animated films, or nostalgic favorites work well.
                Avoid anything intense, dark, or emotionally demanding. The movies on this page are specifically chosen to help you decompress.
              </p>
            </div>
          </div>
          
          <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" class="bg-gw-card border border-gw-border rounded-xl p-5">
            <h3 itemprop="name" class="font-medium mb-2">What's a good movie to watch when tired?</h3>
            <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
              <p itemprop="text" class="text-sm text-gw-text-secondary">
                When you're tired, choose movies under 100 minutes that don't require full attention. 
                Light comedies, animated films, or movies you've seen before work best. 
                Check our "Quick Comfort" section for shorter feel-good options.
              </p>
            </div>
          </div>
          
          <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" class="bg-gw-card border border-gw-border rounded-xl p-5">
            <h3 itemprop="name" class="font-medium mb-2">Are these movies available in India?</h3>
            <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
              <p itemprop="text" class="text-sm text-gw-text-secondary">
                Yes, every movie on this page is verified to be streaming on at least one platform in India 
                (Netflix, Prime Video, JioHotstar, SonyLIV, ZEE5, or JioCinema). We update availability daily.
              </p>
            </div>
          </div>
          
        </div>
      </section>
      
      <!-- CTA -->
      <section class="text-center py-8 border-t border-gw-border">
        <h2 class="text-xl font-semibold mb-3">Let me pick one for you</h2>
        <p class="text-gw-text-secondary mb-6">Get a single comforting movie recommendation — no scrolling, no decisions.</p>
        <a 
          href="/tonight?mood=comforting" 
          class="inline-flex items-center gap-2 bg-gw-accent hover:bg-gw-accent-hover text-gw-bg px-6 py-3 rounded-full font-semibold transition"
        >
          Get Tonight's Comfort Pick →
        </a>
      </section>
      
    </article>
  </main>
</Layout>
