---
import Layout from '../../layouts/Layout.astro';
import { supabase, getPosterUrl, MOODS, slugify } from '../../lib/supabase';

export const prerender = false;

const { mood } = Astro.params;

const moodName = MOODS.find(m => slugify(m) === mood) || mood?.replace(/-/g, ' ');

if (!moodName) {
  return Astro.redirect('/moods');
}

// Mood target profiles for scoring
const MOOD_TARGETS: Record<string, { dimension: string; min: number; max: number; weight: number }[]> = {
  'feel-good': [
    { dimension: 'humour', min: 6, max: 10, weight: 2.0 },
    { dimension: 'comfort', min: 6, max: 10, weight: 1.5 },
    { dimension: 'darkness', min: 0, max: 3, weight: 1.8 },
    { dimension: 'rewatchability', min: 5, max: 10, weight: 1.0 },
  ],
  'thrilling': [
    { dimension: 'energy', min: 6, max: 10, weight: 2.0 },
    { dimension: 'emotionalIntensity', min: 6, max: 10, weight: 1.8 },
    { dimension: 'mentalStimulation', min: 4, max: 10, weight: 1.2 },
  ],
  'romantic': [
    { dimension: 'emotionalIntensity', min: 5, max: 8, weight: 1.8 },
    { dimension: 'comfort', min: 5, max: 10, weight: 1.5 },
    { dimension: 'darkness', min: 0, max: 4, weight: 1.3 },
  ],
  'mind-bending': [
    { dimension: 'mentalStimulation', min: 7, max: 10, weight: 2.2 },
    { dimension: 'complexity', min: 6, max: 10, weight: 2.0 },
    { dimension: 'rewatchability', min: 5, max: 10, weight: 1.0 },
  ],
  'relaxing': [
    { dimension: 'mentalStimulation', min: 0, max: 4, weight: 2.0 },
    { dimension: 'complexity', min: 0, max: 4, weight: 2.0 },
    { dimension: 'comfort', min: 5, max: 10, weight: 1.5 },
    { dimension: 'emotionalIntensity', min: 0, max: 4, weight: 1.5 },
  ],
  'emotional': [
    { dimension: 'emotionalIntensity', min: 7, max: 10, weight: 2.2 },
    { dimension: 'comfort', min: 0, max: 6, weight: 1.0 },
  ],
  'funny': [
    { dimension: 'humour', min: 7, max: 10, weight: 2.5 },
    { dimension: 'darkness', min: 0, max: 3, weight: 1.5 },
    { dimension: 'comfort', min: 5, max: 10, weight: 1.0 },
  ],
  'dark': [
    { dimension: 'darkness', min: 6, max: 10, weight: 2.2 },
    { dimension: 'emotionalIntensity', min: 5, max: 10, weight: 1.5 },
  ],
  'intense': [
    { dimension: 'emotionalIntensity', min: 7, max: 10, weight: 2.2 },
    { dimension: 'energy', min: 6, max: 10, weight: 1.8 },
    { dimension: 'darkness', min: 4, max: 10, weight: 1.3 },
  ],
  'nostalgic': [
    { dimension: 'rewatchability', min: 7, max: 10, weight: 2.0 },
    { dimension: 'comfort', min: 6, max: 10, weight: 1.8 },
    { dimension: 'darkness', min: 0, max: 4, weight: 1.0 },
  ],
  'inspirational': [
    { dimension: 'emotionalIntensity', min: 5, max: 9, weight: 1.8 },
    { dimension: 'comfort', min: 4, max: 9, weight: 1.5 },
    { dimension: 'darkness', min: 0, max: 5, weight: 1.2 },
  ],
  'adventurous': [
    { dimension: 'energy', min: 6, max: 10, weight: 2.0 },
    { dimension: 'emotionalIntensity', min: 4, max: 8, weight: 1.5 },
    { dimension: 'comfort', min: 4, max: 8, weight: 1.0 },
  ],
  'mysterious': [
    { dimension: 'mentalStimulation', min: 6, max: 10, weight: 2.0 },
    { dimension: 'complexity', min: 5, max: 10, weight: 1.8 },
    { dimension: 'darkness', min: 3, max: 8, weight: 1.3 },
  ],
  'uplifting': [
    { dimension: 'comfort', min: 6, max: 10, weight: 2.0 },
    { dimension: 'darkness', min: 0, max: 3, weight: 1.8 },
    { dimension: 'emotionalIntensity', min: 4, max: 8, weight: 1.2 },
  ],
  'thought-provoking': [
    { dimension: 'mentalStimulation', min: 6, max: 10, weight: 2.2 },
    { dimension: 'complexity', min: 5, max: 10, weight: 1.8 },
  ],
};

// Calculate mood score for a movie
function calculateMoodScore(profile: any, moodSlug: string): number {
  const targets = MOOD_TARGETS[moodSlug];
  if (!targets || !profile) return 0;
  
  let totalScore = 0;
  let totalWeight = 0;
  
  for (const target of targets) {
    const value = profile[target.dimension] ?? 5;
    let dimScore = 10;
    
    if (value < target.min) dimScore = Math.max(0, 10 - (target.min - value) * 2);
    else if (value > target.max) dimScore = Math.max(0, 10 - (value - target.max) * 2);
    
    totalScore += dimScore * target.weight;
    totalWeight += target.weight * 10;
  }
  
  return Math.round((totalScore / totalWeight) * 100);
}

// Generate explanation for why movie fits mood
function generateExplanation(profile: any, moodSlug: string): string[] {
  if (!profile) return [];
  const explanations: string[] = [];
  
  if (profile.comfort >= 7) explanations.push('Warm and familiar');
  if (profile.darkness <= 2) explanations.push('Light and uplifting');
  if (profile.humour >= 7) explanations.push('Plenty of laughs');
  if (profile.energy >= 7) explanations.push('High energy');
  if (profile.mentalStimulation >= 7) explanations.push('Thought-provoking');
  if (profile.complexity >= 7) explanations.push('Layered storytelling');
  if (profile.emotionalIntensity >= 7) explanations.push('Deeply moving');
  if (profile.rewatchability >= 8) explanations.push('Highly rewatchable');
  if (profile.emotionalIntensity <= 3 && profile.complexity <= 3) explanations.push('Easy watch');
  
  return explanations.slice(0, 3);
}

// Fetch scored movies
const { data: allMovies } = await supabase
  .from('movies')
  .select('tmdb_id, title, year, poster_path, vote_average, vote_count, emotional_profile, archetype, imdb_rating')
  .not('emotional_profile', 'is', null)
  .not('poster_path', 'is', null)
  .gte('vote_count', 50)
  .order('vote_count', { ascending: false })
  .limit(500);

// Score and sort movies for this mood
const scoredMovies = (allMovies || [])
  .map(m => ({
    ...m,
    moodScore: calculateMoodScore(m.emotional_profile, mood as string),
    explanations: generateExplanation(m.emotional_profile, mood as string),
  }))
  .filter(m => m.moodScore >= 50) // Only show movies that fit
  .sort((a, b) => b.moodScore - a.moodScore);

// Create sections by score band
const perfectFit = scoredMovies.filter(m => m.moodScore >= 80).slice(0, 8);
const goodFit = scoredMovies.filter(m => m.moodScore >= 65 && m.moodScore < 80).slice(0, 12);
const worthTrying = scoredMovies.filter(m => m.moodScore >= 50 && m.moodScore < 65).slice(0, 10);

const sections = [
  { title: `Perfect ${moodName} Movies`, subtitle: 'These fit the mood exactly', movies: perfectFit, band: 'perfect' },
  { title: `Great ${moodName} Picks`, subtitle: 'Strong matches for this mood', movies: goodFit, band: 'good' },
  { title: 'Worth Trying', subtitle: 'A bit of a stretch but still fits', movies: worthTrying, band: 'stretch' },
].filter(s => s.movies.length > 0);

const totalMovies = perfectFit.length + goodFit.length + worthTrying.length;

// SEO
const moodDescriptions: Record<string, { title: string; description: string; h1: string }> = {
  'feel-good': { title: 'Feel-Good Movies to Watch', description: 'Discover the best feel-good movies that will lift your spirits.', h1: 'Feel-Good Movies That Will Brighten Your Day' },
  'thrilling': { title: 'Thrilling Movies to Keep You on Edge', description: 'Browse thrilling movies packed with suspense and excitement.', h1: 'Thrilling Movies for an Adrenaline Rush' },
  'romantic': { title: 'Romantic Movies for Date Night', description: 'Find the perfect romantic movie for any occasion.', h1: 'Romantic Movies That Will Make You Believe in Love' },
  'mind-bending': { title: 'Mind-Bending Movies That Will Blow Your Mind', description: 'Challenge your perception with mind-bending films.', h1: 'Mind-Bending Movies to Make You Think' },
  'relaxing': { title: 'Relaxing Movies for a Chill Night', description: 'Unwind with relaxing movies perfect for a calm evening.', h1: 'Relaxing Movies for When You Need to Unwind' },
  'emotional': { title: 'Emotional Movies That Will Move You', description: 'Find emotional movies that touch the heart.', h1: 'Emotional Movies for When You Want to Feel' },
  'funny': { title: 'Funny Movies to Make You Laugh', description: 'Browse the funniest movies guaranteed to make you smile.', h1: 'Funny Movies Guaranteed to Make You Laugh' },
  'dark': { title: 'Dark Movies for When You Want Intensity', description: 'Explore dark films that do not shy away from difficult themes.', h1: 'Dark Movies for Those Who Like Intensity' },
  'intense': { title: 'Intense Movies That Demand Your Attention', description: 'Discover intense films with gripping plots.', h1: 'Intense Movies You Will Not Be Able to Look Away From' },
  'nostalgic': { title: 'Nostalgic Movies That Bring Back Memories', description: 'Rediscover classics that capture simpler times.', h1: 'Nostalgic Movies for When You Want to Remember' },
  'inspirational': { title: 'Inspirational Movies to Motivate You', description: 'Get inspired with movies that motivate and uplift.', h1: 'Inspirational Movies to Fuel Your Dreams' },
  'adventurous': { title: 'Adventure Movies for Thrill Seekers', description: 'Embark on epic journeys with adventure movies.', h1: 'Adventure Movies That Will Take You Places' },
  'mysterious': { title: 'Mysterious Movies Full of Secrets', description: 'Films full of secrets, twists, and puzzles.', h1: 'Mysterious Movies to Keep You Guessing' },
  'uplifting': { title: 'Uplifting Movies to Boost Your Mood', description: 'Lift your spirits with uplifting movies.', h1: 'Uplifting Movies for When You Need Hope' },
  'thought-provoking': { title: 'Thought-Provoking Movies to Challenge Your Mind', description: 'Films that raise questions and spark discussions.', h1: 'Thought-Provoking Movies That Stay With You' },
};

const seo = moodDescriptions[mood as string] || {
  title: `${moodName} Movies to Watch`,
  description: `Discover the best ${moodName?.toLowerCase()} movies ranked by emotional fit.`,
  h1: `Best ${moodName} Movies`
};
---

<Layout title={seo.title} description={seo.description}>
  <!-- Hero -->
  <section class="py-16 px-4 text-center border-b border-gw-border">
    <div class="max-w-4xl mx-auto">
      <nav class="text-sm text-gw-text-secondary mb-6">
        <a href="/" class="hover:text-white transition">Home</a>
        <span class="mx-2">/</span>
        <a href="/moods" class="hover:text-white transition">Moods</a>
        <span class="mx-2">/</span>
        <span class="text-white">{moodName}</span>
      </nav>
      
      <h1 class="text-3xl md:text-5xl font-bold mb-4">{seo.h1}</h1>
      <p class="text-xl text-gw-text-secondary max-w-2xl mx-auto">{seo.description}</p>
      
      <p class="mt-4 text-sm text-gw-text-secondary">
        Movies ranked by emotional fit, not popularity
      </p>
      
      <div class="mt-6">
        <span class="text-gw-accent font-semibold">{totalMovies} movies</span>
        <span class="text-gw-text-secondary"> match this mood</span>
      </div>
    </div>
  </section>
  
  <!-- Sections -->
  {sections.map((section, idx) => (
    <section class={`py-10 px-4 ${idx % 2 === 1 ? 'bg-gw-card/30' : ''}`}>
      <div class="max-w-7xl mx-auto">
        <div class="flex items-center gap-3 mb-6">
          <h2 class="text-2xl font-bold">{section.title}</h2>
          <span class={`text-xs px-2 py-1 rounded-full ${
            section.band === 'perfect' ? 'bg-green-500/20 text-green-400' :
            section.band === 'good' ? 'bg-blue-500/20 text-blue-400' :
            'bg-yellow-500/20 text-yellow-400'
          }`}>
            {section.band === 'perfect' ? 'Perfect Fit' : section.band === 'good' ? 'Great Match' : 'Worth Trying'}
          </span>
        </div>
        <p class="text-gw-text-secondary text-sm mb-6">{section.subtitle}</p>
        
        {idx === 0 ? (
          <!-- First section: larger cards -->
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
            {section.movies.map((movie: any, i: number) => (
              <a href={`/movie/${movie.tmdb_id}`} class="group">
                <div class="aspect-[2/3] rounded-xl overflow-hidden bg-gw-card mb-3 ring-2 ring-transparent group-hover:ring-gw-accent transition relative">
                  <img 
                    src={getPosterUrl(movie.poster_path, 'w342')} 
                    alt={movie.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                    loading={i < 4 ? 'eager' : 'lazy'}
                  />
                  <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                    <div class="flex flex-wrap gap-1">
                      {movie.explanations.slice(0, 2).map((exp: string) => (
                        <span class="text-xs bg-white/20 backdrop-blur px-2 py-0.5 rounded">{exp}</span>
                      ))}
                    </div>
                  </div>
                </div>
                <h3 class="font-semibold line-clamp-1 group-hover:text-gw-accent transition">{movie.title}</h3>
                <div class="flex items-center gap-2 text-sm text-gw-text-secondary mt-1">
                  <span>{movie.year}</span>
                  {movie.imdb_rating && (
                    <>
                      <span class="text-gw-border">Â·</span>
                      <span class="flex items-center gap-1">
                        <span class="text-yellow-500">IMDb</span> {movie.imdb_rating.toFixed(1)}
                      </span>
                    </>
                  )}
                </div>
              </a>
            ))}
          </div>
        ) : (
          <!-- Other sections: horizontal scroll -->
          <div class="flex gap-4 overflow-x-auto pb-4 -mx-4 px-4 scrollbar-hide">
            {section.movies.map((movie: any) => (
              <a href={`/movie/${movie.tmdb_id}`} class="group flex-shrink-0 w-36">
                <div class="aspect-[2/3] rounded-lg overflow-hidden bg-gw-card mb-2 relative">
                  <img 
                    src={getPosterUrl(movie.poster_path, 'w185')} 
                    alt={movie.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition duration-300"
                    loading="lazy"
                  />
                </div>
                <h3 class="font-medium text-sm line-clamp-1 group-hover:text-gw-accent transition">{movie.title}</h3>
                <div class="text-xs text-gw-text-secondary">{movie.year}</div>
              </a>
            ))}
          </div>
        )}
      </div>
    </section>
  ))}
  
  <!-- Empty state -->
  {sections.length === 0 && (
    <section class="py-20 px-4 text-center">
      <p class="text-gw-text-secondary text-lg">No movies found for this mood yet.</p>
      <a href="/moods" class="inline-block mt-4 text-gw-accent hover:text-gw-accent-hover transition">
        Browse other moods
      </a>
    </section>
  )}
  
  <!-- Other Moods -->
  <section class="py-12 px-4 bg-gw-card/50 border-t border-gw-border">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-2xl font-bold mb-6 text-center">Explore Other Moods</h2>
      <div class="flex flex-wrap justify-center gap-3">
        {MOODS.filter(m => slugify(m) !== mood).slice(0, 10).map((m) => (
          <a 
            href={`/mood/${slugify(m)}`}
            class="px-5 py-2.5 bg-gw-card hover:bg-gw-accent hover:text-gw-bg border border-gw-border rounded-full transition font-medium"
          >
            {m}
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<style>
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>
