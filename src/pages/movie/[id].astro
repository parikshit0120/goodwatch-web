---
import Layout from '../../layouts/Layout.astro';
import { getMovieByTmdbId, getPosterUrl, getBackdropUrl, formatRuntime, type Movie } from '../../lib/supabase';

export const prerender = false; // SSR for dynamic content

const { id } = Astro.params;
const tmdbId = parseInt(id as string);

if (isNaN(tmdbId)) {
  return Astro.redirect('/404');
}

const movie = await getMovieByTmdbId(tmdbId);

if (!movie) {
  return Astro.redirect('/404');
}

// Build Schema.org Movie markup
const movieSchema = {
  "@context": "https://schema.org",
  "@type": "Movie",
  "name": movie.title,
  "description": movie.overview || `Watch ${movie.title} - discover this ${movie.genres?.join(', ')} film.`,
  "image": getPosterUrl(movie.poster_path, 'w500'),
  "datePublished": movie.release_date,
  "duration": movie.runtime ? `PT${movie.runtime}M` : undefined,
  "genre": movie.genres,
  "director": movie.director ? {
    "@type": "Person",
    "name": movie.director
  } : undefined,
  "actor": movie.movie_cast?.slice(0, 5).map(name => ({
    "@type": "Person",
    "name": name
  })),
  "aggregateRating": movie.imdb_rating && movie.imdb_votes ? {
    "@type": "AggregateRating",
    "ratingValue": movie.imdb_rating.toFixed(1),
    "bestRating": "10",
    "worstRating": "0",
    "ratingCount": movie.imdb_votes
  } : undefined,
  "keywords": [...(movie.genres || []), ...(movie.mood_tags || [])].join(', ')
};

// Clean up undefined values
Object.keys(movieSchema).forEach(key => {
  if (movieSchema[key as keyof typeof movieSchema] === undefined) {
    delete movieSchema[key as keyof typeof movieSchema];
  }
});

// SEO description
const seoDescription = movie.overview 
  ? movie.overview.slice(0, 155) + (movie.overview.length > 155 ? '...' : '')
  : `Discover ${movie.title} (${movie.year}) - a ${movie.genres?.slice(0, 2).join(', ')} film. Find out where to watch and see if it matches your mood.`;

// Streaming providers (India first, then US)
const streamingProviders = movie.ott_providers?.filter((p: any) => p.type === "flatrate") || [];

// Provider URL helper - opens provider search with movie title
function getProviderUrl(providerName: string, title: string, year: number): string {
  const query = encodeURIComponent(`${title} ${year || ""}`.trim());
  const providers: Record<string, string> = {
    "Netflix": `https://www.netflix.com/search?q=${query}`,
    "Amazon Prime Video": `https://www.primevideo.com/search?phrase=${query}`,
    "Amazon Prime Video with Ads": `https://www.primevideo.com/search?phrase=${query}`,
    "JioHotstar": `https://www.hotstar.com/in/search?q=${query}`,
    "Disney+ Hotstar": `https://www.hotstar.com/in/search?q=${query}`,
    "Apple TV+": `https://tv.apple.com/search?term=${query}`,
    "SonyLIV": `https://www.sonyliv.com/search?searchTerm=${query}`,
    "Sony Liv": `https://www.sonyliv.com/search?searchTerm=${query}`,
    "Zee5": `https://www.zee5.com/search?q=${query}`,
    "ZEE5": `https://www.zee5.com/search?q=${query}`,
    "JioCinema": `https://www.jiocinema.com/search/${query}`,
    "Jio Cinema": `https://www.jiocinema.com/search/${query}`,
    "Crunchyroll": `https://www.crunchyroll.com/search?q=${query}`,
    "Sun NXT": `https://www.sunnxt.com/search?q=${query}`,
    "Hoichoi": `https://www.hoichoi.tv/search?q=${query}`,
    "Lionsgate Play": `https://www.lionsgateplay.com/search?q=${query}`,
    "MX Player": `https://www.mxplayer.in/search?q=${query}`,
    "Voot": `https://www.voot.com/search?q=${query}`,
    "Aha": `https://www.aha.video/search?q=${query}`,
    "aha": `https://www.aha.video/search?q=${query}`,
    "Mubi": `https://mubi.com/search?query=${query}`,
    "MUBI": `https://mubi.com/search?query=${query}`,
    "VI movies and tv": `https://www.vi.com/moviesandtv/search?q=${query}`,
  };
  return providers[providerName] || `https://www.google.com/search?q=${query}+watch+online`;
}

// Format vote count for display
function formatVotes(votes: number): string {
  if (votes >= 1000000) return (votes / 1000000).toFixed(1) + "M";
  if (votes >= 1000) return Math.round(votes / 1000) + "K";
  return votes.toString();
}
---

<Layout 
  title={`${movie.title} (${movie.year}) - Where to Watch & Movie Details`}
  description={seoDescription}
  image={getBackdropUrl(movie.backdrop_path, 'w1280')}
  type="article"
  schema={movieSchema}
>
  <!-- Backdrop Hero -->
  <section class="relative min-h-[50vh] md:min-h-[60vh]">
    {movie.backdrop_path && (
      <div class="absolute inset-0">
        <img 
          src={getBackdropUrl(movie.backdrop_path, 'w1280')} 
          alt={movie.title}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-gw-bg via-gw-bg/70 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-gw-bg/90 via-transparent to-transparent"></div>
      </div>
    )}
    
    <div class="relative z-10 max-w-7xl mx-auto px-4 pt-20 pb-8 md:pt-32 md:pb-16">
      <div class="flex flex-col md:flex-row gap-8">
        <!-- Poster -->
        <div class="flex-shrink-0 mx-auto md:mx-0">
          <img 
            src={getPosterUrl(movie.poster_path, 'w500')} 
            alt={`${movie.title} poster`}
            class="w-48 md:w-64 rounded-xl shadow-2xl"
          />
        </div>
        
        <!-- Info -->
        <div class="flex-1 text-center md:text-left">
          <h1 class="text-3xl md:text-5xl font-bold mb-3">{movie.title}</h1>
          
          {movie.tagline && (
            <p class="text-lg text-gw-text-secondary italic mb-4">"{movie.tagline}"</p>
          )}
          
          <!-- Meta info -->
          <div class="flex flex-wrap justify-center md:justify-start items-center gap-4 text-sm text-gw-text-secondary mb-6">
            {movie.year && <span>{movie.year}</span>}
            {movie.runtime && (
              <>
                <span>•</span>
                <span>{formatRuntime(movie.runtime)}</span>
              </>
            )}
            {(movie.imdb_rating || movie.vote_average) && (
              <>
                <span>•</span>
                <span class="flex items-center gap-1.5">
                  <span class="bg-[#F5C518] text-black text-xs font-bold px-1.5 py-0.5 rounded">IMDb</span>
                  <span class="font-semibold text-white">{movie.imdb_rating?.toFixed(1) || movie.vote_average?.toFixed(1)}</span>
                  {movie.imdb_votes && (
                    <span class="text-gw-text-secondary">({formatVotes(movie.imdb_votes)})</span>
                  )}
                </span>
              </>
            )}
            {movie.language && (
              <>
                <span>•</span>
                <span class="uppercase">{movie.language}</span>
              </>
            )}
          </div>
          
          <!-- Genres -->
          {movie.genres && movie.genres.length > 0 && (
            <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-6">
              {movie.genres.map((genre) => (
                <a 
                  href={`/genre/${(typeof genre === "string" ? genre : genre.name).toLowerCase().replace(/\s+/g, '-')}`}
                  class="px-3 py-1 bg-gw-card border border-gw-border rounded-full text-sm hover:bg-gw-accent hover:text-gw-bg hover:border-gw-accent transition"
                >
                  {typeof genre === "string" ? genre : genre.name}
                </a>
              ))}
            </div>
          )}
          
          <!-- Actions -->
          <div class="flex flex-wrap justify-center md:justify-start gap-3">
            <button 
              class="flex items-center gap-2 bg-gw-accent hover:bg-gw-accent-hover text-gw-bg px-6 py-3 rounded-full font-semibold transition"
              data-movie-id={movie.tmdb_id}
              id="add-to-watchlist"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add to Watchlist
            </button>
            <button 
              class="flex items-center gap-2 bg-gw-card hover:bg-gw-border border border-gw-border px-6 py-3 rounded-full font-semibold transition"
              id="share-movie"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
              </svg>
              Share
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Content -->
  <section class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-8">
        <!-- Overview -->
        {movie.overview && (
          <div>
            <h2 class="text-xl font-bold mb-3">Overview</h2>
            <p class="text-gw-text-secondary leading-relaxed">{movie.overview}</p>
          </div>
        )}
        
        <!-- Cast -->
        {movie.movie_cast && movie.movie_cast.length > 0 && (
          <div>
            <h2 class="text-xl font-bold mb-3">Cast</h2>
            <div class="flex flex-wrap gap-2">
              {movie.movie_cast.slice(0, 10).map((actor) => (
                <span class="px-3 py-1 bg-gw-card border border-gw-border rounded-full text-sm">
                  {actor}
                </span>
              ))}
            </div>
          </div>
        )}
        
        <!-- Director -->
        {movie.director && (
          <div>
            <h2 class="text-xl font-bold mb-3">Director</h2>
            <span class="px-3 py-1.5 bg-gw-card border border-gw-border rounded-full text-sm">
              {movie.director}
            </span>
          </div>
        )}
        
        <!-- Mood Tags -->
        {movie.mood_tags && movie.mood_tags.length > 0 && (
          <div>
            <h2 class="text-xl font-bold mb-3">Perfect For</h2>
            <div class="flex flex-wrap gap-2">
              {movie.mood_tags.map((mood) => (
                <a 
                  href={`/mood/${mood.toLowerCase().replace(/\s+/g, '-')}`}
                  class="px-3 py-1.5 bg-gw-accent/20 text-gw-accent border border-gw-accent/30 rounded-full text-sm hover:bg-gw-accent hover:text-gw-bg transition"
                >
                  {mood}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
      
      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Where to Watch -->
        <div class="bg-gw-card border border-gw-border rounded-xl p-5">
          <h3 class="text-lg font-bold mb-3">Where to Watch</h3>
          {streamingProviders.length > 0 ? (
            <div class="space-y-2">
              {streamingProviders.map((provider) => (
                <a 
                  href={getProviderUrl(provider.name, movie.title, movie.year)}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-3 p-3 bg-gw-bg rounded-lg hover:bg-gw-border transition group"
                >
                  {provider.logo_path && (
                    <img 
                      src={`https://image.tmdb.org/t/p/w92${provider.logo_path}`}
                      alt={provider.name}
                      class="w-10 h-10 rounded-lg"
                    />
                  )}
                  <span class="font-medium flex-1">{provider.name}</span>
                  <svg class="w-4 h-4 text-gw-text-secondary group-hover:text-gw-accent transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                </a>
              ))}
            </div>
          ) : (
            <p class="text-gw-text-secondary text-sm">
              Streaming availability not found. Check your local services.
            </p>
          )}
        </div>
        
        <!-- Movie Details -->
        <div class="bg-gw-card border border-gw-border rounded-xl p-5">
          <h3 class="text-lg font-bold mb-3">Details</h3>
          <dl class="space-y-3 text-sm">
            {movie.release_date && (
              <div class="flex justify-between">
                <dt class="text-gw-text-secondary">Release Date</dt>
                <dd class="font-medium">{new Date(movie.release_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</dd>
              </div>
            )}
            {movie.runtime && (
              <div class="flex justify-between">
                <dt class="text-gw-text-secondary">Runtime</dt>
                <dd class="font-medium">{formatRuntime(movie.runtime)}</dd>
              </div>
            )}
            {movie.language && (
              <div class="flex justify-between">
                <dt class="text-gw-text-secondary">Language</dt>
                <dd class="font-medium uppercase">{movie.language}</dd>
              </div>
            )}
            {(movie.imdb_votes || movie.vote_count) && (
              <div class="flex justify-between">
                <dt class="text-gw-text-secondary">IMDb Votes</dt>
                <dd class="font-medium">{(movie.imdb_votes || movie.vote_count).toLocaleString()}</dd>
              </div>
            )}
            {movie.imdb_id && (
              <div class="flex justify-between">
                <dt class="text-gw-text-secondary">IMDb</dt>
                <dd>
                  <a 
                    href={`https://www.imdb.com/title/${movie.imdb_id}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-gw-accent hover:underline"
                  >
                    {movie.imdb_id}
                  </a>
                </dd>
              </div>
            )}
          </dl>
        </div>
        
        <!-- Get App CTA -->
        <div class="bg-gradient-to-br from-gw-accent/20 to-gw-accent/5 border border-gw-accent/30 rounded-xl p-5 text-center">
          <h3 class="font-bold mb-2">Discover More Movies</h3>
          <p class="text-sm text-gw-text-secondary mb-3">
            Swipe through movies that match your mood.
          </p>
          <a 
            href="/app" 
            class="inline-block bg-gw-accent hover:bg-gw-accent-hover text-gw-bg px-5 py-2 rounded-full font-semibold text-sm transition"
          >
            Get the App
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://goodwatch.app" },
      { "@type": "ListItem", "position": 2, "name": "Movies", "item": "https://goodwatch.app/movies" },
      { "@type": "ListItem", "position": 3, "name": movie.title, "item": `https://goodwatch.app/movie/${movie.tmdb_id}` }
    ]
  })} />
</Layout>

<script>
  // Share functionality
  document.getElementById('share-movie')?.addEventListener('click', async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: document.title,
          url: window.location.href
        });
      } catch (e) {
        // User cancelled
      }
    } else {
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    }
  });
  
  // Watchlist (saves to localStorage for now)
  document.getElementById('add-to-watchlist')?.addEventListener('click', (e) => {
    const button = e.target as HTMLButtonElement;
    const movieId = button.dataset.movieId;
    
    const watchlist = JSON.parse(localStorage.getItem('goodwatch_watchlist') || '[]');
    if (!watchlist.includes(movieId)) {
      watchlist.push(movieId);
      localStorage.setItem('goodwatch_watchlist', JSON.stringify(watchlist));
      button.textContent = '✓ Added to Watchlist';
      button.classList.add('bg-green-600', 'hover:bg-green-700');
      button.classList.remove('bg-gw-accent', 'hover:bg-gw-accent-hover');
    }
  });
</script>
