---
/**
 * /pick - Core recommendation page
 *
 * GUARDRAILS (NON-NEGOTIABLE):
 * - Fetch EXACTLY ONE movie from Supabase
 * - Availability check BEFORE render (ott_providers must exist)
 * - Never show placeholders or loading UI
 * - Silently replace if unavailable
 *
 * Allowed actions: Watch, Seen this, Not feeling it
 */
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { getOneAvailableMovie, getPosterUrl, getBackdropUrl, getProviderLogoUrl, getWhyThisMovie } from '../lib/movies';
import type { Movie } from '../lib/movies';

// AVAILABILITY CHECK HAPPENS HERE - BEFORE ANY RENDER
// This is the core contract of /pick
let movie: Movie | null = null;

try {
  // TODO: Pass excluded IDs from session interactions when wired
  movie = await getOneAvailableMovie([]);
} catch (e) {
  console.error('Failed to fetch movie from Supabase:', e);
  // Fail silently - will show fallback state
}

// If no movie found, this is a critical failure
// The page will render a recovery state
if (!movie) {
  console.warn('No available movies found in Supabase');
}

// Prepare display data (only if movie exists)
const posterUrl = movie ? getPosterUrl(movie.poster_path) : '';
const backdropUrl = movie ? getBackdropUrl(movie.backdrop_path) : '';
const whyThisMovie = movie ? getWhyThisMovie(movie) : '';
const year = movie?.year || (movie?.release_date ? new Date(movie.release_date).getFullYear() : null);
const providers = movie?.ott_providers || [];
---

<Layout
  title={movie ? `${movie.title} - GoodWatch` : "Pick a Movie - GoodWatch"}
  description="One great movie, available to stream now. No lists, no decision fatigue."
  noIndex={true}
>
  <main class="min-h-screen relative">
    {movie ? (
      <div class="relative">
        {/* Backdrop */}
        {backdropUrl && (
          <div class="fixed inset-0 z-0">
            <img
              src={backdropUrl}
              alt=""
              class="w-full h-full object-cover opacity-20"
              loading="eager"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/90 to-gray-900/70" />
          </div>
        )}

        <div class="relative z-10 max-w-3xl mx-auto px-4 py-8 md:py-16">
          {/* Back link */}
          <a href="/" class="inline-flex items-center text-gray-400 hover:text-white mb-8 text-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back
          </a>

          <div class="flex flex-col md:flex-row gap-8 items-center md:items-start">
            {/* Poster */}
            <div class="flex-shrink-0">
              <img
                src={posterUrl}
                alt={movie.title}
                class="w-56 md:w-64 rounded-xl shadow-2xl"
                loading="eager"
              />
            </div>

            {/* Content */}
            <div class="flex-1 text-center md:text-left">
              <h1 class="text-3xl md:text-4xl font-bold mb-4">{movie.title}</h1>

              {/* Why this movie - ONE LINE ONLY */}
              <p class="text-gray-400 mb-6 italic">
                {whyThisMovie}
              </p>

              {/* Metadata */}
              <div class="flex items-center justify-center md:justify-start gap-4 text-gray-400 text-sm mb-6">
                {year && <span>{year}</span>}
                {movie.runtime && <span>{Math.floor(movie.runtime / 60)}h {movie.runtime % 60}m</span>}
                {movie.vote_average > 0 && (
                  <span class="flex items-center gap-1">
                    <span class="text-yellow-400">â˜…</span>
                    {movie.vote_average.toFixed(1)}
                  </span>
                )}
              </div>

              {/* Genres */}
              {movie.genres && movie.genres.length > 0 && (
                <div class="flex flex-wrap gap-2 justify-center md:justify-start mb-6">
                  {movie.genres.slice(0, 3).map(genre => (
                    <span class="px-3 py-1 bg-gray-800 rounded-full text-xs">
                      {genre.name}
                    </span>
                  ))}
                </div>
              )}

              {/* Streaming - WHERE TO WATCH */}
              {providers.length > 0 && (
                <div class="mb-8">
                  <p class="text-xs text-gray-500 mb-2">Available on</p>
                  <div class="flex gap-2 justify-center md:justify-start">
                    {providers.map(provider => (
                      <div
                        class="w-10 h-10 rounded-lg overflow-hidden bg-gray-800"
                        title={provider.name}
                      >
                        <img
                          src={getProviderLogoUrl(provider.logo_path)}
                          alt={provider.name}
                          class="w-full h-full object-cover"
                          loading="eager"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ACTIONS - ONLY THESE THREE ALLOWED */}
              <div class="flex flex-col sm:flex-row gap-3 justify-center md:justify-start">
                {/* Watch - Primary action */}
                <button
                  id="btn-watch"
                  data-movie-id={movie.id}
                  class="bg-white text-black px-8 py-4 rounded-full font-bold hover:bg-gray-200 transition-colors flex items-center justify-center gap-2"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
                  </svg>
                  Watch
                </button>

                {/* Seen this */}
                <button
                  id="btn-seen"
                  data-movie-id={movie.id}
                  class="border border-gray-600 px-6 py-4 rounded-full font-medium hover:border-gray-400 transition-colors"
                >
                  Seen this
                </button>

                {/* Not feeling it */}
                <button
                  id="btn-reject"
                  data-movie-id={movie.id}
                  class="border border-gray-600 px-6 py-4 rounded-full font-medium hover:border-gray-400 transition-colors"
                >
                  Not feeling it
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    ) : (
      /* Recovery state - should rarely happen if Supabase is populated */
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="text-center max-w-md">
          <h1 class="text-2xl font-bold mb-4">No movies available right now</h1>
          <p class="text-gray-400 mb-6">
            We're curating more recommendations. Please check back soon.
          </p>
          <a
            href="/"
            class="inline-block bg-white text-black px-6 py-3 rounded-full font-bold hover:bg-gray-200 transition-colors"
          >
            Go Home
          </a>
        </div>
      </div>
    )}
  </main>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';

  /**
   * Action handlers for /pick
   * iOS Parity: Uses GWInteraction schema
   *
   * Actions: watch_now, already_seen, not_tonight
   * Session ID persists for rejection learning
   */

  // Initialize Supabase client for browser
  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // Session management - persists in localStorage
  function getSessionId(): string {
    const key = 'gw_session_id';
    let sessionId = localStorage.getItem(key);
    if (!sessionId) {
      sessionId = `web_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
      localStorage.setItem(key, sessionId);
    }
    return sessionId;
  }

  // Get current time of day (iOS parity)
  function getTimeOfDay(): string {
    const hour = new Date().getHours();
    if (hour >= 6 && hour < 12) return 'morning';
    if (hour >= 12 && hour < 17) return 'afternoon';
    if (hour >= 17 && hour < 21) return 'evening';
    return 'night';
  }

  // Map web action to iOS action names
  function mapAction(webAction: string): string {
    switch (webAction) {
      case 'watched': return 'watch_now';
      case 'seen': return 'already_seen';
      case 'rejected': return 'not_tonight';
      default: return 'shown';
    }
  }

  // Record interaction to Supabase (iOS schema)
  async function recordInteraction(movieId: string, webAction: string): Promise<boolean> {
    const sessionId = getSessionId();
    const iosAction = mapAction(webAction);

    const { error } = await supabase.from('interactions').insert({
      user_id: '00000000-0000-0000-0000-000000000000', // Anonymous web user
      movie_id: movieId,
      action: iosAction,
      rejection_reason: webAction === 'rejected' ? 'not_in_mood' : null,
      context: {
        session_id: sessionId,
        time_of_day: getTimeOfDay(),
      },
      created_at: new Date().toISOString(),
    });

    if (error) {
      console.error('Failed to record interaction:', error.message);
      return false;
    }
    return true;
  }

  const btnWatch = document.getElementById('btn-watch');
  const btnSeen = document.getElementById('btn-seen');
  const btnReject = document.getElementById('btn-reject');

  async function handleAction(movieId: string, action: string) {
    // Record to Supabase (fire and forget for UX)
    recordInteraction(movieId, action);

    // Store in sessionStorage for exclusion on reload
    const excluded = JSON.parse(sessionStorage.getItem('gw_excluded') || '[]');
    excluded.push(movieId);
    sessionStorage.setItem('gw_excluded', JSON.stringify(excluded));

    // Refresh to get next movie
    window.location.reload();
  }

  btnWatch?.addEventListener('click', () => {
    const movieId = btnWatch.getAttribute('data-movie-id');
    if (movieId) {
      handleAction(movieId, 'watched');
    }
  });

  btnSeen?.addEventListener('click', () => {
    const movieId = btnSeen.getAttribute('data-movie-id');
    if (movieId) {
      handleAction(movieId, 'seen');
    }
  });

  btnReject?.addEventListener('click', () => {
    const movieId = btnReject.getAttribute('data-movie-id');
    if (movieId) {
      handleAction(movieId, 'rejected');
    }
  });
</script>
